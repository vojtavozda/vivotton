# Vivotton

The goal of this repo is to provide enough information for eager users to flash their own code to the box and bring it to life â€“ without needing to dismantle it, decipher faded codes on soldered parts, or probe traces with a multimeter.

Supported HW version is **2.0**.

## ESP32-S3

The MCU which does all the calculations and readouts is **ESP32-S3 N16R8**.

### Programming

USB-C input on the side of the box is connected to the **S3**'s integrated USB port. When using **PlatformIO**, following flags should be included in `platformio.ini`:

```ini
build_flags = -DARDUINO_USB_CDC_ON_BOOT=1
upload_flags = --no-stub
```

Programming over UART is also possible and can be done only with an external programmer. The PCB has a 6-pin IDC connector prepared.

## List of peripherals

### Arcade buttons

One connector of each button is tied to `GND`, second leads to given GPIO. Use of internal pull-up resistors is required for correct readout.

- `GPIO 6`: Red button
- `GPIO 4`: Blue button
- `GPIO 17`: Yellow button
- `GPIO 15`: Green button

### LEDs in arcade buttons

Cathodes of LED are tied to `GND`, anodes are wired through resistors towards given GPIOs:

- `GPIO 7`: LED in red button
- `GPIO 5`: LED in blue button
- `GPIO 18`: LED in yellow button
- `GPIO 16`: LED in green button

### Addressable RGB LEDs

Vivotton uses **SK9822** addressable LEDs (clone of **APA-102C**):

- `CLK`: Clock signal is connected to `GPIO 1`
- `DATA`: Data signal is connected to `GPIO 2`

LED strip is wired in counterclockwise direction starting from the left edge of the side where the power button is located. At each corner (between two adjacent sides) there is one additional LED with no visible output. One additional LED is placed also between end of the fourth edge and a smaller indicator LED located right next to the power button.

For better clarity, here are indexes of all the usable LEDs:

- `[0-4]`: Front side (red and blue buttons)
- `[6-10]`: Right side (blue and yellow buttons)
- `[12-16]`: Back side (yellow and green buttons)
- `[18-22]`: Left side (green and red buttons)
- `[24]`: Indicator LED

### Audio

Audio output employs a digital potentiometer **MCP4101**, amplifier **PAM8304** and a 2W-speaker with a small resistor.

#### MCP4101

This digital potentiometer is used to programmable volume control. It uses SPI interface:

- `CS`: SPI chip select signal is connected to `GPIO 10`
- `MOSI`: SPI *'master out, slave in'*  is connected to `GPIO 11`
- `SCK`: SPI clock signal is connected to `GPIO 12`

#### PAM8304

This 3W mono class-d amplifier is used to amplify audio signal generated by the EPS32-S3. It's shutdown terminal `/SD` is connected to `GPIO 3`. In order to generate sound, this pin has to be pulled up.

#### Speaker

The speaker is connected to `GPIO 9`. The signal travels from `GPIO 9` through the amplification line (**MCP4101**, **PAM8304** ) to the speaker's positive pin.

### Battery

Battery voltage can be read from a voltage divider which consists of `100k` (to `VBAT+`) and `51k` (to `GND`) resistors. Voltage from the divider can be read using `GPIO 13`.

Charging is controlled by **MCP73831**. It's `STAT` pin value can be read by `GPIO 14` (TBD).

### LED in the power button

The power button has built-in LED which can be controlled using `GPIO 38`.

## Examples

The following examples are intended to help users with initial setup and debugging. The focus is on code simplicity rather than performance. All of them use **PlatformIO** and the **Arduino Wiring-based Framework**.

### hello_world

Just try to get response from the ESP and turn on/off leds located in buttons.

### hit_the_mole

Very simple version of the game where uses has to hit button which is lit up. This code tests behavior of the four leds and buttons.

### speaker

Tone generation using espressif's [LEDC](https://docs.espressif.com/projects/arduino-esp32/en/latest/api/ledc.html) library. This also enables **PAM8304** amplifier and uses **MCP4101** to control volume.

### addressable_leds

Basic example how to initialize [FastLED](https://fastled.io/) library.
